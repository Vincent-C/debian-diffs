From 6de5eb9ffbbad7065ce34b3c267f2f95e4f45ea1 Mon Sep 17 00:00:00 2001
From: Werner Lemberg <wl@gnu.org>
Date: Mon, 24 Nov 2014 10:51:21 +0100
Subject: [sfnt] Fix Savannah bug #43680. CVE-2014-9656

This adds an additional constraint to make the fix from 2013-01-25
really work.

* src/sfnt/ttsbit.c (tt_sbit_decoder_load_image) <index_format==4>:
Check `p' before `num_glyphs'.

(cherry picked from commit f0292bb9920aa1dbfed5f53861e7c7a89b35833a)
---
 freetype-2.5.2/src/sfnt/ttsbit.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git freetype-2.5.2/src/sfnt/ttsbit.c freetype-2.5.2/src/sfnt/ttsbit.c
index 7469ff1..38c680e 100644
--- freetype-2.5.2/src/sfnt/ttsbit.c
+++ freetype-2.5.2/src/sfnt/ttsbit.c
@@ -1143,7 +1143,8 @@
         num_glyphs = FT_NEXT_ULONG( p );
 
         /* overflow check for p + ( num_glyphs + 1 ) * 4 */
-        if ( num_glyphs > (FT_ULong)( ( ( p_limit - p ) >> 2 ) - 1 ) )
+        if ( p + 4 > p_limit                                         ||
+             num_glyphs > (FT_ULong)( ( ( p_limit - p ) >> 2 ) - 1 ) )
           goto NoBitmap;
 
         for ( mm = 0; mm < num_glyphs; mm++ )
-- 
2.1.4

