From 8d2acf52b8f956338f7b381817d3fdb06b64f756 Mon Sep 17 00:00:00 2001
From: Werner Lemberg <wl@gnu.org>
Date: Thu, 6 Nov 2014 22:32:46 +0100
Subject: Fix Savannah bug #43547. CVE-2014-9671

* src/pcf/pcfread.c (pcf_read_TOC): Check `size' and `offset'
values.

(cherry picked from commit 0e2f5d518c60e2978f26400d110eff178fa7e3c3)
---
 freetype-2.5.2/src/pcf/pcfread.c | 15 +++++++++++++++
 1 file changed, 15 insertions(+)

diff --git freetype-2.5.2/src/pcf/pcfread.c freetype-2.5.2/src/pcf/pcfread.c
index c7d38e1..f487faa 100644
--- freetype-2.5.2/src/pcf/pcfread.c
+++ freetype-2.5.2/src/pcf/pcfread.c
@@ -151,6 +151,21 @@ THE SOFTWARE.
         break;
     }
 
+    /* we now check whether the `size' and `offset' values are reasonable: */
+    /* `offset' + `size' must not exceed the stream size                   */
+    tables = face->toc.tables;
+    for ( n = 0; n < toc->count; n++ )
+    {
+      /* we need two checks to avoid overflow */
+      if ( ( tables->size   > stream->size                ) ||
+           ( tables->offset > stream->size - tables->size ) )
+      {
+        error = FT_THROW( Invalid_Table );
+        goto Exit;
+      }
+      tables++;
+    }
+
 #ifdef FT_DEBUG_LEVEL_TRACE
 
     {
-- 
2.1.4

